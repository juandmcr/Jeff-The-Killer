#!/bin/bash
# - * - * - * - * - * - * - * - * - * - * - * - * - #
#                   CONSTS & CONFIG                 #
# - * - * - * - * - * - * - * - * - * - * - * - * - #
VERSION="1.0.2"
SettingsPath="$HOME/.config/JeffTheKiller"
SettingsFile="$HOME/.config/JeffTheKiller/settings.conf"

declare -a settingsOrder=(
  "MAX_IDLE_TIME"
  "MAX_AUDIO_IDLE_TIME"
  "USE_AUDIO_IDLE_FOR_SLEEP"
  "CHECK_AGAIN_EVERY"
  "ENABLE_SCREEN_SAVER"
  "SCREEN_SAVER_AFTER"
  "SCREEN_SAVER_WITH_AUDIO"
  "ENABLE_SCREEN_LOCK"
  "SCREEN_LOCK_COMMAND"
  "SUSPEND_MODE"
)

declare -A settings=(
  [MAX_IDLE_TIME]=17 #minutes (keyboard/mouse idle)
  [MAX_AUDIO_IDLE_TIME]=0 #minutes (audio idle, 0 = same as MAX_IDLE_TIME, used for both screensaver and sleep when relevant)
  [USE_AUDIO_IDLE_FOR_SLEEP]=true
  [CHECK_AGAIN_EVERY]=15 #seconds
  [ENABLE_SCREEN_SAVER]=true
  [ENABLE_SCREEN_LOCK]=false
  [SCREEN_LOCK_COMMAND]="i3lock-fancy"
  [SCREEN_SAVER_AFTER]=0 #minutes | 0 = default = 10 mins
  [SCREEN_SAVER_WITH_AUDIO]=false
  [SUSPEND_MODE]="dbus"
)

declare -A descriptions=(
  [MAX_IDLE_TIME]="Maximum keyboard/mouse idle time (in minutes) before considering you AFK. System will sleep after this time if audio has also been idle long enough (when USE_AUDIO_IDLE_FOR_SLEEP is true) or immediately when no audio is playing (when false)."
  [MAX_AUDIO_IDLE_TIME]="Maximum audio idle time (in minutes) before allowing the system to sleep (when USE_AUDIO_IDLE_FOR_SLEEP is true) and before allowing the screen to turn off when SCREEN_SAVER_WITH_AUDIO is false. 0 = same as MAX_IDLE_TIME."
  [USE_AUDIO_IDLE_FOR_SLEEP]="If true, use audio idle time (MAX_AUDIO_IDLE_TIME) as an additional requirement before suspending. If false, suspend logic only checks current audio state (backwards-compatible behavior)."
  [CHECK_AGAIN_EVERY]="Time interval (in seconds) to re-check for inactivity when you're active or audio is playing. Lower values are more responsive."
  [ENABLE_SCREEN_LOCK]="Enable screen locking before system sleep. If true, your screen locker will run before suspension."
  [SCREEN_LOCK_COMMAND]="Screen locker command. Make sure this command exists and works on your system (e.g., i3lock, slock, dm-tool lock)."
  [ENABLE_SCREEN_SAVER]="Enable screen power management. If true, your screen will turn off after specified idle time."
  [SCREEN_SAVER_AFTER]="Minutes of keyboard/mouse inactivity before screen turns off. 0 uses default (10 minutes). Only works if ENABLE_SCREEN_SAVER is true."
  [SCREEN_SAVER_WITH_AUDIO]="If true, screen can turn off after SCREEN_SAVER_AFTER based only on keyboard/mouse idle. If false, screen will only turn off when keyboard/mouse have been idle for MAX_IDLE_TIME and audio has also been idle for MAX_AUDIO_IDLE_TIME."
  [SUSPEND_MODE]="Method to suspend system: 'dbus' (recommended, no sudo) or 'systemctl' (requires polkit rule, see README.md)."
)


# - * - * - * - * - * - * - * - * - * - * - * - * - #
#                   Utilities                       #
# - * - * - * - * - * - * - * - * - * - * - * - * - #
clearScreen() {
  printf "\033[2J\033[1;1H"
}

printHeader() {
  clearScreen
  echo "╔══════════════════════════════════════════════════════════╗"
  echo "║             JEFF THE KILLER - Sleep Manager              ║"
  echo "║                   Version $VERSION                          ║"
  echo "╚══════════════════════════════════════════════════════════╝"
  echo ""
}

pause() {
  read -r -p "Press Enter to continue..."
}

toLower() {
  echo "$1" | tr '[:upper:]' '[:lower:]'
}

toUpper() {
  echo "$1" | tr '[:lower:]' '[:upper:]'
}

isNumber() {
  local input=$1
  [[ -n "$input" && "$input" =~ ^[0-9]+$ ]]
}

msToMin() {
  local ms=$1
  local seconds=$((ms / 1000))
  local minutes=$((seconds / 60))
  echo "$minutes"
}

trim() {
  local var="$*"
  var="${var#"${var%%[![:space:]]*}"}"
  var="${var%"${var##*[![:space:]]}"}"
  echo -n "$var"
}

settingExists() {
  local key="$1"
  [[ -n "${settings[$key]+x}" ]]
}

uninstallFiles(){
  clearScreen
  echo "Uninstalling JeffTheKiller's files..."

  systemctl --user stop gotosleep.service 2>/dev/null
  systemctl --user disable gotosleep.service 2>/dev/null

  pkill -f "jeffthekiller --daemon" 2>/dev/null

  echo "Removing $HOME/.local/bin/jeffthekiller"
  rm "$HOME/.local/bin/jeffthekiller" 2>/dev/null
  echo "Removing $SettingsFile"
  rm "$SettingsFile" 2>/dev/null
  echo "Removing $HOME/.config/systemd/user/gotosleep.service"
  rm "$HOME/.config/systemd/user/gotosleep.service" 2>/dev/null

  systemctl --user daemon-reload 2>/dev/null

  echo ""
  read -r -p "Restart PulseAudio to avoid audio issues? (y/n): " restart_pulse
  if [ "$(toLower "$restart_pulse")" = "y" ]; then
    echo "Restarting PulseAudio..."
    systemctl --user restart pulseaudio.service 2>/dev/null || pulseaudio -k 2>/dev/null
    echo "PulseAudio restarted. You may need to restart your applications for audio to work properly."
  else
    echo "Skipping PulseAudio restart. If you experience audio issues, try restarting PulseAudio manually."
  fi

  echo ""
  echo "Note: If you installed the polkit rule for systemd suspension mode you may need to remove it yourself:"
  echo "sudo rm /etc/polkit-1/rules.d/85-suspend-no-auth.rules"
  echo ""
  echo "All Jeff The Killer files installed with the Installation Wizard have been uninstalled from your system."
  echo ""
}


# - * - * - * - * - * - * - * - * - * - * - * - * - #
#                   funcs for config                #
# - * - * - * - * - * - * - * - * - * - * - * - * - #
loadSettings() {
  if [[ -f $SettingsFile ]]; then
    while IFS= read -r line || [[ -n $line ]]; do
      [[ -z "${line// /}" ]] && continue
      [[ "${line##\#*}" != "$line" ]] && continue

      key="${line%%=*}"
      value="${line#*=}"

      key="$(trim "$key")"
      if [[ "${value:0:1}" == '"' && "${value: -1}" == '"' ]]; then
        value="${value:1:-1}"
      elif [[ "${value:0:1}" == "'" && "${value: -1}" == "'" ]]; then
        value="${value:1:-1}"
      fi
      value="$(trim "$value")"

      if settingExists "$key"; then
        settings["$key"]="$value"
      fi
    done < "$SettingsFile"
  else
    echo "No Settings File found at"
    echo "$SettingsPath"
    echo "Default settings will be used."
  fi
}


saveSettings() {
  mkdir -p "$SettingsPath" 2>/dev/null
  {
    for key in "${settingsOrder[@]}"
    do
      val="${settings[$key]}"
      printf '%s="%s"\n' "$key" "${val//\"/\\\"}"
    done
  } > "$SettingsFile"
}



# - * - * - * - * - * - * - * - * - * - * - * - * - #
#                   Main Logic Funcs                #
# - * - * - * - * - * - * - * - * - * - * - * - * - #
isAudioActive() {
  for i in {1..3}
  do
    if pactl list sinks short 2>/dev/null | grep -q RUNNING; then
      return 0
    fi
    sleep 0.5
  done
  return 1
}

isAFK() {
  currentIdleTime=$(xprintidle 2>/dev/null || echo 0)
  local idleMinutes
  idleMinutes=$(msToMin "$currentIdleTime")
  local maxIdle="${settings[MAX_IDLE_TIME]}"

  if ! isNumber "$maxIdle"; then
    maxIdle=17
  fi

  [ "$idleMinutes" -ge "$maxIdle" ]
  return $?
}

CHANGExsetBehaviour() {
  currentIdleTime=$(xprintidle 2>/dev/null || echo 0)

  if [[ "${settings[ENABLE_SCREEN_SAVER]}" != "true" ]]; then
    # Screen saver globally disabled: keep DPMS off
    sleep 0.5
    xset s off -dpms 2>/dev/null
    return
  fi

  local time="${settings[SCREEN_SAVER_AFTER]}"
  if ! isNumber "$time" || [ "$time" -eq 0 ]; then
    time=10
  fi

  local idleMinutes
  idleMinutes=$(msToMin "$currentIdleTime")

  local maxIdle="${settings[MAX_IDLE_TIME]}"
  if ! isNumber "$maxIdle"; then
    maxIdle=17
  fi

  local maxAudioIdle="${settings[MAX_AUDIO_IDLE_TIME]}"
  if ! isNumber "$maxAudioIdle" || [ "$maxAudioIdle" -lt 0 ]; then
    maxAudioIdle=0
  fi
  if [ "$maxAudioIdle" -eq 0 ]; then
    maxAudioIdle="$maxIdle"
  fi

  local audioIdleMinutes=0
  if [ -n "${GLOBAL_AUDIO_IDLE_MINUTES+x}" ]; then
    audioIdleMinutes="$GLOBAL_AUDIO_IDLE_MINUTES"
  fi

  local screenSaverAud=false
  [[ "${settings[SCREEN_SAVER_WITH_AUDIO]}" == "true" ]] && screenSaverAud=true

  local shouldScreensave=false

  if $screenSaverAud; then
    [ "$idleMinutes" -ge "$time" ] && shouldScreensave=true
  else
    if [ "$idleMinutes" -ge "$time" ] && \
       [ "$idleMinutes" -ge "$maxIdle" ] && \
       [ "$audioIdleMinutes" -ge "$maxAudioIdle" ]; then
      shouldScreensave=true
    fi
  fi

  if $shouldScreensave; then
    sleep 0.5
    xset dpms force off 2>/dev/null
  else
    sleep 0.5
    xset dpms force on 2>/dev/null
  fi
}


checkAgain() {
  currentIdleTime=$(xprintidle 2>/dev/null || echo 0)
  CHANGExsetBehaviour

  local time="${settings[CHECK_AGAIN_EVERY]}"
  if ! isNumber "$time"; then
    time=15
  fi

  sleep "$time"
}

goToSleep() {
  if [[ "${settings[ENABLE_SCREEN_LOCK]}" == "true" ]] ; then
    if [[ -n "${settings[SCREEN_LOCK_COMMAND]}" ]]; then
        bash -c "${settings[SCREEN_LOCK_COMMAND]}"
        sleep 1
    fi
  fi

  local mode=$(toLower "${settings[SUSPEND_MODE]}")
  if [ "$mode" = "dbus" ]; then
    if ! dbus-send --system --print-reply --dest=org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager.Suspend boolean:true 2>/dev/null; then
      echo "Error: dbus-send failed. Trying fallback to systemctl..." >&2
      if ! systemctl suspend; then
        echo "Error: Could not suspend system. You may need to install the polkit rule or switch to 'dbus' mode." >&2
      fi
    fi
  elif [ "$mode" = "systemctl" ]; then
    if ! systemctl suspend; then
      echo "Error: systemctl suspend failed. Ensure you have installed the polkit rule (85-suspend-no-auth.rules)." >&2
    fi
  else
    echo "Error: Unknown SUSPEND_MODE '${settings[SUSPEND_MODE]}'. Using dbus as fallback." >&2
    dbus-send --system --print-reply --dest=org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager.Suspend boolean:true 2>/dev/null
  fi

  sleep 30
}

mainLoop() {
  sleep 10
  if ! command -v xprintidle &>/dev/null; then
    echo "xprintidle seems to be missing or not installed, it is a very important dependency."
    echo "Please, install it using:"
    echo "sudo apt install xprintidle"
    echo "and try again."
    exit 1
  fi

  while ! pactl info &>/dev/null
  do
    sleep 1
  done

  local lastAudioActiveTimestamp
  lastAudioActiveTimestamp=$(date +%s)

  while :
  do
    currentIdleTime=$(xprintidle 2>/dev/null || echo 0)
    local useAudioIdle="${settings[USE_AUDIO_IDLE_FOR_SLEEP]}"
    local maxAudioIdle="${settings[MAX_AUDIO_IDLE_TIME]}"
    if ! isNumber "$maxAudioIdle" || [ "$maxAudioIdle" -lt 0 ]; then
      maxAudioIdle=0
    fi
    if [ "$maxAudioIdle" -eq 0 ]; then
      maxAudioIdle="${settings[MAX_IDLE_TIME]}"
      if ! isNumber "$maxAudioIdle"; then
        maxAudioIdle=17
      fi
    fi
    if isAudioActive; then
      lastAudioActiveTimestamp=$(date +%s)
    fi

    local now
    now=$(date +%s)
    local audioIdleSeconds=$((now - lastAudioActiveTimestamp))
    local audioIdleMinutes=$((audioIdleSeconds / 60))

    GLOBAL_AUDIO_IDLE_MINUTES="$audioIdleMinutes"

    if isAFK; then
      if [[ "$(toLower "$useAudioIdle")" == "true" ]]; then
        if [ "$audioIdleMinutes" -ge "$maxAudioIdle" ]; then
          goToSleep
          lastAudioActiveTimestamp=$(date +%s)
        else
          checkAgain
        fi
      else
        if ! isAudioActive; then
          goToSleep
          lastAudioActiveTimestamp=$(date +%s)
        else
          checkAgain
        fi
      fi
    else
      checkAgain
    fi
  done
}


# - * - * - * - * - * - * - * - * - * - * - * - * - #
#                      VISUALS                      #
# - * - * - * - * - * - * - * - * - * - * - * - * - #
wrapDescriptionBox() {
  local description="$1"
  local width=56
  local processed_desc=""

  description=$(echo -e "$description")

  IFS=' ' read -ra words <<< "$description"

  local currentLine=""
  for word in "${words[@]}"; do
    if [ $((${#currentLine} + ${#word} + 1)) -gt $width ]; then
      if [ -n "$currentLine" ]; then
        processed_desc+="║ $currentLine"
        local padding=$((width - ${#currentLine}))
        printf -v padding_str "%*s" "$padding" ""
        processed_desc+="$padding_str ║\n"
      fi
      currentLine="$word"
    else
      if [ -z "$currentLine" ]; then
        currentLine="$word"
      else
        currentLine+=" $word"
      fi
    fi
  done

  if [ -n "$currentLine" ]; then
    processed_desc+="║ $currentLine"
    local padding=$((width - ${#currentLine}))
    printf -v padding_str "%*s" "$padding" ""
    processed_desc+="$padding_str ║"
  fi

  echo -e "$processed_desc"
}

updateSetting() {
  while true; do
    printHeader
    echo "Available settings:"
    echo "╔══════════════════════════════╗╔══════════════════════════╗"
    for key in "${settingsOrder[@]}"
    do
      local value="${settings[$key]}"
      if [ ${#value} -gt 20 ]; then
        value="${value:0:20}.."
      fi
      printf "║ %-28s ║║ %-24s ║\n" "$key" "$value"
    done
    echo "╚══════════════════════════════╝╚══════════════════════════╝"
    echo ""
    echo "Enter setting name to modify, 'b' to go back, or press Ctrl+C to exit."
    echo ""

    read -r -p "Setting name: " sname

    if [[ "$(toLower "$sname")" == "b" ]] || [[ "$sname" == "back" ]]; then
      return 0
    fi

    local settingName=$(toUpper "$sname")

    if settingExists "$settingName"; then
      while true; do
          printHeader
          echo "╔══════════════════════════════════════════════════════════╗"
          echo "║                      UPDATE SETTING                      ║"
          echo "╠══════════════════════════════════════════════════════════╣"
          echo "║ Setting:   $settingName                                   "
          echo "║ Current:   ${settings[$settingName]}                      "
          echo "║                                                          ║"
          echo "║ Description:                                             ║"

          local description="${descriptions[$settingName]}"
          wrapped_desc=$(wrapDescriptionBox "$description")
          echo -e "$wrapped_desc"

          echo "║                                                          ║"
          echo "╠══════════════════════════════════════════════════════════╣"
          echo "║ Enter 'b' to go back, 'c' to cancel, or new value below. ║"
          echo "╚══════════════════════════════════════════════════════════╝"
          echo ""

        read -r -p "New value (or b/c): " nval

        case "$(toLower "$nval")" in
          b|back)
            break
            ;;
          c|cancel)
            return 0
            ;;
          *)
            if [[ -z "$nval" ]]; then
              printHeader
              echo "✗ Error: Value cannot be empty!"
              echo "Please enter a valid value or 'c' to cancel."
              sleep 2
              continue
            fi

            settings["$settingName"]="$nval"
            saveSettings
            loadSettings

            printHeader
            echo "✓ Setting '$settingName' successfully updated to: $nval"
            echo ""

            if [ "$settingName" = "SUSPEND_MODE" ] && [ "$(toLower "$nval")" = "systemctl" ]; then
              echo "⚠  Note: 'systemctl' mode requires the polkit rule."
              echo "   Ensure you have placed '85-suspend-no-auth.rules' in /etc/polkit-1/rules.d/"
              echo ""
            fi

            read -r -p "Restart service to apply changes now? (y/n): " ans
            if [ "$(toLower "$ans")" = "y" ]; then
              systemctl --user restart gotosleep.service
              echo "✓ Service restarted!"
              sleep 1
            else
              echo "ℹ  Remember to restart the service later with: jeffthekiller -r"
              sleep 2
            fi

            read -r -p "Modify another setting? (y/n): " another
            if [ "$(toLower "$another")" = "y" ]; then
              break
            else
              return 0
            fi
            ;;
        esac
      done
    else
      printHeader
      echo "✗ Invalid setting name: '$sname'"
      echo "Please enter a valid setting name from the list above."
      echo ""
      read -r -p "Press Enter to continue or 'b' to go back... " choice
      if [[ "$(toLower "$choice")" == "b" ]]; then
        return 0
      fi
    fi
  done
}

showCurrentLogic() {
  echo "CURRENT SLEEP/SCREENSAVER LOGIC:"
  echo "================================"

  local maxIdle="${settings[MAX_IDLE_TIME]}"
  local maxAudioIdle="${settings[MAX_AUDIO_IDLE_TIME]}"
  local useAudioIdle="${settings[USE_AUDIO_IDLE_FOR_SLEEP]}"
  local checkInterval="${settings[CHECK_AGAIN_EVERY]}"
  local screenSaverEnabled="${settings[ENABLE_SCREEN_SAVER]}"
  local screenSaverTime="${settings[SCREEN_SAVER_AFTER]}"
  local screenSaverWithAudio="${settings[SCREEN_SAVER_WITH_AUDIO]}"

  if ! isNumber "$screenSaverTime" || [ "$screenSaverTime" -eq 0 ]; then
    screenSaverTime=10
  fi

  if ! isNumber "$maxIdle" || [ "$maxIdle" -le 0 ]; then
    maxIdle=17
  fi

  if ! isNumber "$maxAudioIdle" || [ "$maxAudioIdle" -lt 0 ]; then
    maxAudioIdle=0
  fi
  if [ "$maxAudioIdle" -eq 0 ]; then
    maxAudioIdle="$maxIdle"
  fi

  if [[ "$(toLower "$useAudioIdle")" == "true" ]]; then
    echo "Sleep: System will suspend when keyboard/mouse have been idle for $maxIdle minutes AND audio has also been idle for $maxAudioIdle minutes."
  else
    echo "Sleep: System will suspend when keyboard/mouse have been idle for $maxIdle minutes, but ONLY if no audio is playing at that moment."
  fi

  if [[ "$screenSaverEnabled" == "true" ]]; then
    if [[ "$screenSaverWithAudio" == "true" ]]; then
      echo "Screensaver: Screen will turn off after $screenSaverTime minutes of keyboard/mouse inactivity, EVEN if audio is playing."
    else
      echo "Screensaver: Screen will turn off only when:"
      echo "  - Keyboard/mouse have been idle for at least $screenSaverTime minutes,"
      echo "  - AND keyboard/mouse have been idle for at least $maxIdle minutes,"
      echo "  - AND audio has been idle for at least $maxAudioIdle minutes."
    fi
  else
    echo "Screensaver: Disabled (Jeff's built-in screen saver is turned off)."
  fi

  echo "Idle Check Interval: Inactivity and audio state are checked every $checkInterval seconds."

  if [[ "${settings[ENABLE_SCREEN_LOCK]}" == "true" ]]; then
    echo "Screen Lock: Will lock before system sleep using: ${settings[SCREEN_LOCK_COMMAND]}"
  else
    echo "Screen Lock: Disabled"
  fi

  echo "Suspend Mode: Using ${settings[SUSPEND_MODE]}"
  echo ""
}

showHelp() {
  loadSettings
  printHeader
  showCurrentLogic

  echo "# Jeff The Killer - Sleep Manager #"
  echo "===================================="
  echo "Manages screen power and system suspend based on keyboard/mouse idle time AND audio activity."
  echo ""
  echo "REQUIREMENTS:"
  echo "- X11 environment (not Wayland)"
  echo "- xprintidle (sudo apt install xprintidle)"
  echo "- PulseAudio (usually preinstalled)"
  echo ""
  echo "FILES:"
  echo "- Script: $0 && $HOME/.local/bin/jeffthekiller"
  echo "- Settings: $SettingsFile"
  echo "- Service: $HOME/.config/systemd/user/gotosleep.service"
  echo "- Optional polkit rule: /etc/polkit-1/rules.d/85-suspend-no-auth.rules"
  echo "  (Only needed if you use SUSPEND_MODE=systemctl)"
  echo ""
  echo "SUSPEND MODES:"
  echo "- dbus: Uses dbus-send (recommended, no sudo required)"
  echo "- systemctl: Uses systemctl suspend (requires polkit rule)"
  echo ""
  echo "USAGE:"
  echo "  jeffthekiller           # Start with menu"
  echo "  jeffthekiller --daemon  # Start directly without menu"
  echo "  jeffthekiller -d        # Disable systemd service"
  echo "  jeffthekiller -d X      # Disable for X minutes"
  echo "  jeffthekiller -dl       # Shows logs of active disable command"
  echo "  jeffthekiller -r        # Restart systemd service"
  echo "  jeffthekiller -s        # Show status of systemd service"
  echo "  jeffthekiller -j        # Show journalctl of systemd service"
  echo "  jeffthekiller -h    # Show this help"
  echo ""
  echo "NOTE: After changing settings, restart the service with: jeffthekiller -r"
  echo ""
  echo "Thanks to whoever using this, (me, my mom, my cat and maybe Z.S. :wilted_rose:)"
  pause
}

installMenu() {
  printHeader
  echo "╔══════════════════════════════════════════════════════════╗"
  echo "║          JEFF THE KILLER - Installation Wizard           ║"
  echo "╚══════════════════════════════════════════════════════════╝"
  echo ""
  read -r -p "Do you want to install automatically? (y/n): " autoInstall

  if [ "$(toLower "$autoInstall")" = "y" ]; then
    echo ""
    echo "Installing..."
    echo "────────────"

    mkdir -p "$HOME/.config/systemd/user" 2>/dev/null
    mkdir -p "$SettingsPath" 2>/dev/null
    mkdir -p "$HOME/.local/bin" 2>/dev/null

    if [ -f "jeffthekiller" ]; then
      local path="$(pwd)/jeffthekiller"
      cp "$path" "$HOME/.local/bin/jeffthekiller"
      chmod +x "$HOME/.local/bin/jeffthekiller" 2>/dev/null
      echo "✓ Script copied to ~/.local/bin/"
    else
      echo "✗ Script file 'jeffthekiller' not found in current directory"
    fi

    if [ -f "gotosleep.service" ]; then
      cp "gotosleep.service" "$HOME/.config/systemd/user/"
      echo "✓ Systemd service installed"
    else
      echo "✗ Service file 'gotosleep.service' not found"
      echo "  No systemd service was created (Check the readme for manual installation)"
    fi

    if [ -f "85-suspend-no-auth.rules" ]; then
      echo ""
      echo "⚠  Polkit rule file found!"
      echo "   If you plan to use SUSPEND_MODE=systemctl, install it with:"
      echo "   sudo cp 85-suspend-no-auth.rules /etc/polkit-1/rules.d/"
      echo "   sudo systemctl restart polkit"
    fi

    saveSettings
    echo "✓ Configuration saved"

    systemctl --user daemon-reload
    systemctl --user enable gotosleep.service 2>/dev/null
    systemctl --user start gotosleep.service 2>/dev/null

    echo ""
    echo "╔══════════════════════════════════════════════════════════╗"
    echo "║                 INSTALLATION SUCCEEDED!                  ║"
    echo "╚══════════════════════════════════════════════════════════╝"
    echo ""
    echo "✓ Jeff The Killer and its systemd service are installed"
    echo "✓ Service will auto-start with your user session"
    echo ""
    echo "You can now from everywhere in your system:"
    echo "• Use 'jeffthekiller' to access this menu"
    echo "• Use 'jeffthekiller -r' to restart the service"
    echo "• Use 'jeffthekiller -s' to check service status"
    echo "• Use 'jeffthekiller -j' to check service's journalctl"
    echo "• Use 'jeffthekiller -d X' to disable jeffthekiller/gotosleep for X minutes"
    echo "• Use 'jeffthekiller -d' to disable jeffthekiller/gotosleep completely until restart"
    echo "• Use 'jeffthekiller -h' to see your current sleep logic and help"
    echo ""
  else
    echo ""
    echo "Manual installation detected."

    if [ -f "$HOME/.config/systemd/user/gotosleep.service" ]; then
      echo "Service file found. Creating configuration..."
      saveSettings
      echo "✓ Configuration created"
      echo "✓ You can now access the main menu"
      pause
      return 0
    else
      echo "Manual installation required. Please check README.md and jeffthekiller --help."
      echo "Or run the installation again and select 'y' for automatic installation."
      pause
      exit 1
    fi
  fi
  pause
}

showMenu() {
  loadSettings

  if [[ -f $SettingsFile ]]; then
    while :
    do
      printHeader
      echo "╔══════════════════════════════════════════════════════════╗"
      echo "║                        MAIN MENU                         ║"
      echo "╠══════════════════════════════════════════════════════════╣"
      echo "║ 1) Edit settings                                         ║"
      echo "║ 2) Help                                                  ║"
      echo "║ 3) Launch in terminal (without systemd service)          ║"
      echo "║ 4) Exit and start systemd service                        ║"
      echo "║ 5) Exit                                                  ║"
      echo "║ 6) Uninstall and exit                                    ║"
      echo "╚══════════════════════════════════════════════════════════╝"
      echo ""
      read -r -p "Select an option (1-6): " option

      case "$option" in
        1)
          updateSetting
          ;;
        2)
          showHelp
          ;;
        3)
          printHeader
          echo "Starting Jeff The Killer in the terminal..."
          echo "Press Ctrl+C to stop and return to menu"
          echo ""
          echo "Status: Active"
          echo "────────────────"
          loadSettings
          trap 'echo ""; echo "Returning to menu..."; sleep 2; continue' INT
          mainLoop
          ;;
        4)
          printHeader
          echo "Starting systemd service..."
          systemctl --user start gotosleep.service 2>/dev/null
          if [ $? -eq 0 ]; then
            echo "✓ Service started successfully!"
            echo "✓ It will auto-start with your user session"
          else
            echo "✗ Failed to start service"
            echo "  Make sure the service file is installed"
          fi
          pause
          exit 0
          ;;
        5|exit)
          printHeader
          echo "Exiting Jeff The Killer >:D"
          echo ""
          echo "Remember:"
          echo "• Use 'jeffthekiller -r' to start/restart the service"
          echo "• Use 'jeffthekiller' to access this menu again"
          echo ""
          exit 0
          ;;
        6)
          read -r -p "Are you sure that you want to uninstall all JeffTheKiller/GoToSleep's Files? (Only affects files installed with the Installation Wizard) [Y/N]: " confirmation
          case "$confirmation" in
            y|Y)
              uninstallFiles
              echo "Exiting..."
              exit 0
              ;;
            n|N)
              :
              ;;
          esac
          ;;
        *)
          printHeader
          echo "✗ Invalid option: $option"
          echo "  Please select a number between 1 and 6"
          pause
          ;;
      esac
    done
  else
    printHeader
    echo "╔══════════════════════════════════════════════════════════╗"
    echo "║                    FIRST TIME SETUP                      ║"
    echo "╚══════════════════════════════════════════════════════════╝"
    echo ""
    read -r -p "Is this your first time (re-)installing Jeff The Killer in this system? (y/n) " answer

    case "$(toLower "$answer")" in
      y)
        installMenu
        showMenu
        ;;
      n)
        printHeader
        echo "Settings file not found at:"
        echo "  $SettingsFile"
        echo ""
        echo "This suggests the settings file was moved or deleted."
        echo ""
        read -r -p "Do you want to create a new configuration file with default settings? (y/n): " createNew

        if [ "$(toLower "$createNew")" = "y" ]; then
          saveSettings
          echo "✓ New configuration created with default settings"
          echo "✓ Restarting menu..."
          sleep 2
          showMenu
        else
          echo "Exiting. You can manually restore your settings or run the installation again."
          exit 1
        fi
        ;;
      *)
        echo "Invalid answer"
        exit 1
        ;;
    esac
  fi
}


# - * - * - * - * - * - * - * - * - * - * - * - * - #
#                   argparser                       #
# - * - * - * - * - * - * - * - * - * - * - * - * - #
while [[ $# -gt 0 ]]; do
  case $1 in
    --daemon)
      shift
      sleep 10
      loadSettings
      mainLoop
      ;;
    -d|--disable)
      shift
      DISABLE_MINUTES=0
      if isNumber "$1"; then
        DISABLE_MINUTES=$1
        shift
      fi

      systemctl --user stop gotosleep.service

      if [ "$DISABLE_MINUTES" -gt 0 ]; then
        disablePIDFile="$SettingsPath/disable_gotosleep_$$.pid"

        mkdir -p "$SettingsPath" 2>/dev/null

        setsid bash -c "
          echo \"\$(date +%T) USER: Service disabled for $DISABLE_MINUTES minutes\"

          sleep $((DISABLE_MINUTES * 60))
          systemctl --user start gotosleep.service
          echo \"\$(date +%T) AUTO: Service re-enabled after $DISABLE_MINUTES minutes (disabled by user)\"

          rm -f \"$disablePIDFile\" 2>/dev/null
        " 2>&1 | systemd-cat -t jeffthekiller -p info &

        echo $! > "$disablePIDFile"
        disown $! 2>/dev/null

        echo "$(date +%T) JeffTheKiller/GoToSleep will be disabled for $DISABLE_MINUTES minutes."
        echo "[Logs will be saved in jeffthekiller -dl]"
      else
        echo "$(date +%T) USER: Service disabled permanently (for this session)"
      fi
      exit 0
      ;;
    -dl|--disablelogs)
      shift
      journalctl --user -t jeffthekiller -f
      echo "[If you don't see anything no logs for the disable command were found]"
      exit 0
      ;;
    -r|--restart)
      shift
      systemctl --user restart gotosleep.service
      exit 0
      ;;
    -s|--status)
      shift
      systemctl --user status gotosleep.service
      exit 0
      ;;
    -j|--journal)
      shift
      journalctl --user -u gotosleep -f -q
      exit 0
      ;;
    -h|--help)
      showHelp
      exit 0
      ;;
    *)
      echo -e "Unknown argument: $1\nShowing Help:\n---------------\n"
      showHelp
      exit 1
      ;;
  esac
done


# - * - * - * - * - * - * - * - * - * - * - * - * - #
#                    Main Loop                      #
# - * - * - * - * - * - * - * - * - * - * - * - * - #
showMenu
